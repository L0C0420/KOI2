<script>
// ===== CLOUDINARY CONFIGURATION =====
// Replace these with your actual Cloudinary credentials
const CLOUDINARY_CLOUD_NAME = 'dcywjsotl';  // e.g., 'dzxyz1234'
const CLOUDINARY_UPLOAD_PRESET = 'htt8kvs5';  // e.g., 'koi_uploads'

let koiList = [];
let contactSettings = {};
let selectedFiles = [];
let editingKoiId = null;
let nextKoiId = 1;

// Netlify Identity Authentication
netlifyIdentity.on('init', user => {
    if (user) {
        document.getElementById('loginPrompt').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        loadData();
        renderKoi();
    } else {
        document.getElementById('loginPrompt').style.display = 'block';
        document.getElementById('adminContent').style.display = 'none';
    }
});

netlifyIdentity.on('login', user => {
    document.getElementById('loginPrompt').style.display = 'none';
    document.getElementById('adminContent').style.display = 'block';
    loadData();
    renderKoi();
    netlifyIdentity.close();
});

netlifyIdentity.on('logout', () => {
    document.getElementById('loginPrompt').style.display = 'block';
    document.getElementById('adminContent').style.display = 'none';
});

async function loadData() {
    try {
        const response = await fetch('/api/get-koi');
        if (!response.ok) throw new Error('Failed to load');
        const data = await response.json();
        koiList = data.koiList || [];
        contactSettings = data.contactSettings || {};
        
        document.getElementById('whatsappNumber').value = contactSettings.whatsapp || '';
        document.getElementById('instagramUsername').value = contactSettings.instagram || '';
        document.getElementById('facebookUrl').value = contactSettings.facebook || '';
        
        nextKoiId = Math.max(...koiList.map(k => k.id), 0) + 1;
    } catch (error) {
        console.error('Error loading data:', error);
        koiList = [];
        contactSettings = {};
    }
}

async function saveData() {
    try {
        const user = netlifyIdentity.currentUser();
        const token = user?.token?.access_token;
        
        if (!token) {
            alert('Please log in again to save changes.');
            netlifyIdentity.open();
            return false;
        }
        
        const response = await fetch('/api/save-koi', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                koiList,
                contactSettings
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to save');
        }
        return true;
    } catch (error) {
        console.error('Error saving data:', error);
        alert('Error saving data: ' + error.message);
        return false;
    }
}

// ===== CLOUDINARY UPLOAD FUNCTION =====
async function uploadToCloudinary(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    
    // Determine resource type
    const resourceType = file.type.startsWith('video/') ? 'video' : 'image';
    
    const response = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`,
        {
            method: 'POST',
            body: formData
        }
    );
    
    if (!response.ok) {
        throw new Error('Failed to upload to Cloudinary');
    }
    
    const data = await response.json();
    return data.secure_url;
}

async function saveContactSettings() {
    contactSettings.whatsapp = document.getElementById('whatsappNumber').value;
    contactSettings.instagram = document.getElementById('instagramUsername').value;
    contactSettings.facebook = document.getElementById('facebookUrl').value;
    const success = await saveData();
    if (success) {
        alert('Contact settings saved!');
    }
}

document.getElementById('mediaInput').addEventListener('change', function(e) {
    selectedFiles = Array.from(e.target.files);
    updateMediaPreview();
});

function updateMediaPreview() {
    const preview = document.getElementById('mediaPreview');
    preview.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'media-preview-item';
            
            if (file.type.startsWith('image/')) {
                div.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button class="remove-media" onclick="removeMedia(${index})">√ó</button>
                `;
            } else if (file.type.startsWith('video/')) {
                div.innerHTML = `
                    <video src="${e.target.result}"></video>
                    <button class="remove-media" onclick="removeMedia(${index})">√ó</button>
                `;
            }
            
            preview.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
}

function removeMedia(index) {
    selectedFiles.splice(index, 1);
    updateMediaPreview();
}

function editKoi(id) {
    const koi = koiList.find(k => k.id === id);
    if (!koi) return;

    editingKoiId = id;
    document.getElementById('formTitle').textContent = 'Edit Koi';
    document.getElementById('koiName').value = koi.name;
    document.getElementById('koiDescription').value = koi.description;
    document.getElementById('koiPrice').value = koi.price;
    document.getElementById('koiSize').value = koi.size || '';
    document.getElementById('koiQuantity').value = koi.quantity !== undefined ? koi.quantity : 1;
    document.getElementById('koiAge').value = koi.age || '';
    document.getElementById('koiGender').value = koi.gender || '';
    document.getElementById('koiType').value = koi.type || '';
    document.getElementById('koiBreeder').value = koi.breeder || '';
    document.getElementById('koiStatus').value = koi.status || 'available';
    document.getElementById('saveBtn').textContent = 'Update Koi';
    document.getElementById('cancelBtn').style.display = 'block';

    document.querySelector('.admin-controls').scrollIntoView({ behavior: 'smooth' });
}

function cancelEdit() {
    editingKoiId = null;
    document.getElementById('formTitle').textContent = 'Add New Koi';
    document.getElementById('koiName').value = '';
    document.getElementById('koiDescription').value = '';
    document.getElementById('koiPrice').value = '';
    document.getElementById('koiSize').value = '';
    document.getElementById('koiQuantity').value = '1';
    document.getElementById('koiAge').value = '';
    document.getElementById('koiGender').value = '';
    document.getElementById('koiType').value = '';
    document.getElementById('koiBreeder').value = '';
    document.getElementById('koiStatus').value = 'available';
    document.getElementById('mediaInput').value = '';
    selectedFiles = [];
    document.getElementById('mediaPreview').innerHTML = '';
    document.getElementById('saveBtn').textContent = 'Add Koi';
    document.getElementById('cancelBtn').style.display = 'none';
}

async function saveKoi() {
    const name = document.getElementById('koiName').value;
    const description = document.getElementById('koiDescription').value;
    const price = document.getElementById('koiPrice').value;
    const size = document.getElementById('koiSize').value;
    const quantity = document.getElementById('koiQuantity').value;
    const age = document.getElementById('koiAge').value;
    const gender = document.getElementById('koiGender').value;
    const type = document.getElementById('koiType').value;
    const breeder = document.getElementById('koiBreeder').value;
    const status = document.getElementById('koiStatus').value;

    if (!name || !description || !price) {
        alert('Please fill in name, description, and price');
        return;
    }

    if (!editingKoiId && selectedFiles.length === 0) {
        alert('Please select at least one image or video');
        return;
    }

    document.getElementById('loadingOverlay').classList.add('active');

    try {
        let media = [];
        
        // Upload files to Cloudinary if new files are selected
        if (selectedFiles.length > 0) {
            const uploadPromises = selectedFiles.map(file => uploadToCloudinary(file));
            const urls = await Promise.all(uploadPromises);
            
            media = urls.map(url => ({
                type: url.includes('video') ? 'video' : 'image',
                url: url
            }));
        }

        if (editingKoiId) {
            const koi = koiList.find(k => k.id === editingKoiId);
            if (koi) {
                koi.name = name;
                koi.description = description;
                koi.price = parseFloat(price);
                koi.size = parseFloat(size) || null;
                koi.quantity = parseInt(quantity) || 0;
                koi.age = age;
                koi.gender = gender;
                koi.type = type;
                koi.breeder = breeder;
                koi.status = status;
                
                // Only update media if new files were uploaded
                if (media.length > 0) {
                    koi.media = media;
                }
            }
        } else {
            koiList.push({
                id: nextKoiId++,
                name: name,
                description: description,
                price: parseFloat(price),
                size: parseFloat(size) || null,
                quantity: parseInt(quantity) || 0,
                age: age,
                gender: gender,
                type: type,
                breeder: breeder,
                status: status,
                order: koiList.length,
                media: media
            });
        }

        const success = await saveData();
        if (success) {
            alert('Koi saved successfully!');
            cancelEdit();
            renderKoi();
        }
    } catch (error) {
        console.error('Error saving koi:', error);
        alert('Failed to save koi: ' + error.message);
    } finally {
        document.getElementById('loadingOverlay').classList.remove('active');
    }
}

async function deleteKoi(id) {
    if (confirm('Are you sure you want to delete this koi?')) {
        koiList = koiList.filter(k => k.id !== id);
        await saveData();
        renderKoi();
    }
}

async function moveKoi(id, direction) {
    const index = koiList.findIndex(k => k.id === id);
    if (index === -1) return;

    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex < 0 || newIndex >= koiList.length) return;

    [koiList[index], koiList[newIndex]] = [koiList[newIndex], koiList[index]];
    koiList.forEach((koi, i) => koi.order = i);
    await saveData();
    renderKoi();
}

function updateInventoryCount() {
    const available = koiList.filter(k => k.status !== 'sold').length;
    const sold = koiList.filter(k => k.status === 'sold').length;
    const total = koiList.length;
    
    document.getElementById('inventoryCount').textContent = 
        `Total: ${total} koi ‚Ä¢ ${available} Available ‚Ä¢ ${sold} Sold`;
}

function renderKoi() {
    updateInventoryCount();
    const grid = document.getElementById('koiGrid');
    grid.innerHTML = '';

    koiList.sort((a, b) => a.order - b.order).forEach((koi, index) => {
        const card = document.createElement('div');
        card.className = 'koi-card';
        
        let detailsHTML = '';
        if (koi.size || koi.age || koi.gender || koi.type) {
            detailsHTML = '<div class="koi-details">';
            if (koi.type) detailsHTML += `<span class="koi-detail-item">${koi.type}</span>`;
            if (koi.size) detailsHTML += `<span class="koi-detail-item">${koi.size}cm</span>`;
            if (koi.age) detailsHTML += `<span class="koi-detail-item">${koi.age}</span>`;
            if (koi.gender) detailsHTML += `<span class="koi-detail-item">${koi.gender}</span>`;
            detailsHTML += '</div>';
        }

        const isOutOfStock = koi.quantity === 0 && koi.status !== 'sold';
        const showQuantity = koi.quantity !== undefined && koi.quantity !== 1;

        const mediaItem = koi.media && koi.media[0];
        const mediaHTML = mediaItem ? (
            mediaItem.type === 'image' ? 
            `<img src="${mediaItem.url}" alt="${koi.name}" class="media-item active">` :
            `<video src="${mediaItem.url}" class="media-item active"></video>`
        ) : '<div class="media-item active" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">No image</div>';

        card.innerHTML = `
            ${koi.status === 'sold' ? '<div class="sold-badge">SOLD</div>' : ''}
            ${isOutOfStock ? '<div class="out-of-stock-badge">OUT OF STOCK</div>' : ''}
            ${showQuantity ? `<div class="quantity-badge">Qty: ${koi.quantity}</div>` : ''}
            <div class="media-carousel">${mediaHTML}</div>
            <div class="koi-info">
                <div class="koi-name">${koi.name}</div>
                ${detailsHTML}
                <div class="koi-description">${koi.description}</div>
                ${koi.breeder ? `<p style="color: #999; font-size: 13px; margin-bottom: 10px;">üèÜ ${koi.breeder}</p>` : ''}
                <div class="koi-price">R ${koi.price.toLocaleString()}</div>
                <div class="action-buttons" style="display: flex; gap: 10px;">
                    ${index > 0 ? `<button class="reorder-btn" onclick="moveKoi(${koi.id}, 'up')" style="flex: 0 0 40px; padding: 8px;">‚Üë</button>` : ''}
                    ${index < koiList.length - 1 ? `<button class="reorder-btn" onclick="moveKoi(${koi.id}, 'down')" style="flex: 0 0 40px; padding: 8px;">‚Üì</button>` : ''}
                </div>
                <div class="action-buttons">
                    <button class="edit-btn" onclick="editKoi(${koi.id})">Edit</button>
                    <button class="delete-btn" onclick="deleteKoi(${koi.id})">Delete</button>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}
</script>
